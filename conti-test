# Conti-test docker img
FROM ubuntu:20.04

# Openssh server, sudo and tini (init)
RUN apt update && apt install -y sudo openssh-server tini python3 && \
mkdir /var/run/sshd

# Ansible user and group + no sudo pass
RUN groupadd -g 71000 ansible && useradd -m -u 71000 -g 71000 -s /bin/bash ansible && \
echo 'ansible ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers 

# SSH key storage (need a better name)
RUN mkdir -p /home/ansible/.ssh && chown ansible:ansible /home/ansible/.ssh && \
chmod 700 /home/ansible/.ssh

## Copy ssh keys 
COPY id_ed.pub /home/ansible/.ssh/authorized_keys

## Expose ssh port to outside, needed for ansible
EXPOSE 22

# Tini as init 
ENTRYPOINT ["/usr/bin/tini", "--"] 

# Start ssh daemon
CMD ["/usr/sbin/sshd", "-D"]
